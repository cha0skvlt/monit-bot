# Руководство по проекту мониторинга веб-сайтов

Данный документ описывает работу Telegram-бота для отслеживания доступности
сайтов и срока действия SSL‑сертификатов. Инструкция рассчитана на разработчиков
и администраторов, желающих развернуть и модифицировать проект.

## Содержание

1. [Структура репозитория](#structure)
2. [Запуск через Docker](#docker)
3. [Запуск напрямую через Python](#python-run)
4. [Переменные окружения](#env)
5. [Логирование и состояние](#logging)
6. [Фоновые задачи](#background)
7. [Телеграм-команды](#commands)
8. [Тестирование](#tests)
9. [Расширение функционала](#extend)

<a name="structure"></a>
## 1. Структура репозитория

- `bot.py` – основной входной скрипт Telegram-бота. Здесь регистрируются все
  команды и запускаются фоновые потоки.
- `core.py` – функции ядра: проверка сайтов, проверка SSL, отправка
  уведомлений, работа с файлами.
- `db.sqlite` – база данных SQLite с сайтами, статусами и логами.
- `Dockerfile` и `docker-compose.yml` – файлы для контейнеризации.
- `tests/` – модульные тесты, покрывающие основные функции.
- `logs/` – каталог для журналов (создается автоматически).

<a name="docker"></a>
## 2. Запуск через Docker

1. Скопируйте файл `.env.example` в `.env` и укажите токен бота и ID чата:
   ```bash
   cp .env.example .env
   # отредактируйте .env
   ```

2. Запустите `./telegram_test.sh` — скрипт сам прочитает `.env` и отправит тестовое сообщение.

3. Соберите и запустите контейнер:
   ```bash
   docker compose up --build -d
   ```
    Контейнер создаст базу SQLite при первом запуске. При желании можно изменить
    путь к ней через переменную `DB_FILE`, а также настроить `LOG_FILE` и
    `REQUEST_TIMEOUT`.

<a name="python-run"></a>
## 3. Запуск напрямую через Python

Установите зависимости и запустите `bot.py`:
```bash
pip install -r requirements.txt
python bot.py
```
Бот начнет опрашивать сайты и принимать команды в Telegram и будет оставаться
активным, так как вызов `updater.idle()` блокирует основной поток. Для
долговременной работы рекомендуется использовать Docker либо иной менеджер
процессов.

<a name="env"></a>
## 4. Переменные окружения

- `BOT_TOKEN` – токен вашего Telegram-бота.
- `CHAT_ID` – идентификатор чата, куда будут отправляться уведомления.

Дополнительные переменные позволяют настроить приложение:

- `DB_FILE` – путь к базе SQLite (по умолчанию `/app/db.sqlite`). Если указать
  каталог, файл `db.sqlite` будет создан внутри него.
- `LOG_FILE` – файл журнала событий (по умолчанию `/app/logs/monitor.log`).
- `REQUEST_TIMEOUT` – таймаут HTTP-запросов в секундах (по умолчанию `10`).

Все переменные загружаются через `dotenv`. `BOT_TOKEN` и `CHAT_ID` обязательны,
остальные имеют значения по умолчанию.

<a name="logging"></a>
## 5. Логирование и состояние

Все события сохраняются в базу SQLite и дублируются в файл `logs/monitor.log`
(переменная `LOG_FILE`). Так журналы можно легко отправлять в Grafana Loki или
ELK.

В таблице `status` базы хранятся даты последнего падения сайтов. Не удаляйте эти
записи без необходимости – так бот сможет правильно вычислять длительность
недоступности.

<a name="background"></a>
## 6. Фоновые задачи

В `bot.py` запускаются два потока:

- `background_loop` – ежеминутно вызывает `check_sites()` и, если время 03:00
  UTC, запускает `check_ssl()`.
- `daily_ssl_loop` (из `core.py`) – ежедневно в 06:00 UTC выполняет полную
  проверку SSL и при необходимости отправляет уведомления.
Если сайт не отвечает хотя бы 3 минуты подряд, бот отправит предупреждение и
затем будет напоминать каждый час, пока ресурс не восстановится. Если список
сайтов пуст, `check_sites()` сразу завершает работу без ошибок.
Проверка выполнена в несколько этапов: после неудачного HTTP‑запроса происходит
попытка подключения по сокету, что снижает риск ложных срабатываний из‑за
кеширования DNS или кратковременных сетевых ошибок.

Такой подход обеспечивает регулярное отслеживание состояния без внешних планировщиков.

<a name="commands"></a>
## 7. Телеграм-команды

Бот поддерживает следующие команды:


- `/start` – справка и список команд.
- `/status` – показать текущий статус всех сайтов.
- `/ssl` – вручную проверить срок действия SSL‑сертификатов.
- `/list` – вывести список отслеживаемых URL.
- `/add <url>` – добавить сайт в мониторинг.
- `/remove <url>` – удалить сайт.
- Команда `/status` использует актуальный список сайтов, поэтому добавление или
  удаление сразу отражается в её выводе.
- Сайт отображается как OK только если последний ответ вернул код 200.


Каждый обработчик посылает статус "печатает" в чат, чтобы пользователь видел активность бота.

<a name="tests"></a>
## 8. Тестирование

Тесты запускаются стандартным инструментом `pytest`:
```bash
pip install -r requirements.txt
pytest -q
```
В папке `tests/` находятся сценарии, покрывающие функции ядра и обработчики
команд. Они помогают убедиться, что изменения не ломают ключевой функционал.

<a name="extend"></a>
## 9. Расширение функционала

- **Добавление проверок**. В `core.py` можно реализовать дополнительные методы
  проверки (например, TCP‑порты или время отклика). Главное – корректно
  логировать события и при необходимости отправлять уведомления.
- **Другое хранилище**. При желании хранить данные не в файлах, а в базе (Redis,
  PostgreSQL), замените функции `load_*` и `save_*` на работу с выбранным
  хранилищем.
- **Интеграция с системами наблюдения**. Так как логи структурированы,
  их легко интегрировать с внешними системами мониторинга.

Это руководство призвано дать общее понимание работы проекта и помочь
адаптировать его под свои задачи.

## Версия

Текущий релиз: **1.1**
